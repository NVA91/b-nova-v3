---
# Hardware profile for pve01 (Single Source of Truth)
# This file is intended to be loaded into the inventory as:
#   hardware_profile: "{{ lookup('file', playbook_dir + '/inventory/hardware/pve01.yml') | from_yaml }}"

spec:
  name: "pve01"
  description: "Mini-PC Proxmox Host mit OCuLink-eGPU"
  type: "mini_pc"

  cpu:
    model: "AMD Ryzen 7 H255"
    cores: 8
    threads: 16
    features:
      - "NPU"

  memory:
    total_gb: 32
    type: "DDR5"
    speed_mt_s: 5600

  storage:
    vm_disk:
      device: "/dev/nvme0n1"
      size_tb: 2
      type: "NVMe SSD"
      model: "WD Black"
      interface: "PCIe 4.0 x4"
      purpose: "VM Storage"

    storage_disk:
      device: "/dev/nvme1n1"
      size_tb: 2
      type: "NVMe SSD"
      interface: "PCIe 4.0 x4"
      purpose: "Storage"

    system_disk:
      device: "/dev/nvme2n1"
      size_tb: 1
      type: "NVMe SSD"
      purpose: "Proxmox OS"

  gpu:
    igpu:
      vendor: "amd"
      model: "AMD Radeon 780M"

network:
  lan:
    ports: 2
    speed_gbps: 2.5
    controllers:
      - vendor: "Realtek"
        model: "RTL8125BG"
        pci_device_id: "10ec:8125"
        count: 2

  wifi:
    enabled: true
    standard: "Wi-Fi 6E"

  bluetooth:
    enabled: true
    version: "5.2"

chassis:
  connectivity:
    oculink:
      enabled: true
      note: "Mini-PC mit OCuLink-Port"
  features:
    - "LÃ¼fter-/LED-Steuerung"

gpu:
  egpu:
    enabled: true
    dock:
      model: "Minisforum DEG1"
      interface: "OCuLink (PCIe Gen4 x4)"
    model: "NVIDIA RTX 5060 Ti"
    vram_gb: 16
    passthrough:
      enabled: true
      pci_id: "0000:01:00.0"
      audio_pci_id: "0000:01:00.1"
      pci_device_id: "10de:2d04"
      audio_device_id: "10de:22eb"
      iommu_group: 17
      vfio_ids:
        - "10de:2d04"
        - "10de:22eb"

npu:
  enabled: true
  model: "AMD XDNA (Ryzen AI Engine)"
  tops: 16
  pci_id: "1022:1502"
  driver: "amd-xdna"
  kernel_min_version: "6.8"

# Host behaviour / platform configuration derived from the hardware profile
proxmox:
  zfs_enabled: false
  storage_thin_pool: "local-lvm"
  vm_storage: "local-lvm"
  backup_storage: "fanxiang-backup"
  dir_storage: "wd-vm"

  allow_docker_in_lxc: true
  lxc_container_ids:
    - 100
    - 105

  gpu_passthrough:
    kernel_cmdline: "quiet amd_iommu=on iommu=pt vfio-pci.ids=10de:2d04,10de:22eb video=efifb:off"
    vfio_modules:
      - vfio
      - vfio_iommu_type1
      - vfio_pci
      - vfio_virqfd
    blacklist_modules:
      - nouveau
      - nvidia
      - nvidia_drm
      - nvidia_modeset

docker:
  global_limits:
    cpu_count: 14
    memory: "28g"
    swap: "4g"
  agent_defaults:
    cpu_shares: 1024
    memory: "2g"
    memory_reservation: "1g"
  agent_profiles:
    core:     { cpu_count: 4, memory: "4g", priority: "high" }
    devops:   { cpu_count: 2, memory: "3g", priority: "high" }
    security: { cpu_count: 2, memory: "2g", priority: "high" }
    research: { cpu_count: 2, memory: "3g", priority: "medium" }
    dev:      { cpu_count: 2, memory: "2g", priority: "medium" }
    media:    { cpu_count: 2, memory: "4g", gpu_access: true, priority: "medium" }
    business: { cpu_count: 1, memory: "2g", priority: "low" }
    health:   { cpu_count: 1, memory: "1g", priority: "low" }
    ai:       { cpu_count: 3, memory: "6g", gpu_access: true, priority: "high" }

performance:
  governor: "performance"
  swappiness: 10
  docker_storage_driver: "overlay2"
  network:
    tcp_fastopen: true
    tcp_bbr: true
  io_scheduler: "mq-deadline"

power:
  mode: "balanced"
  profiles:
    powersave:
      cpu_governor: "powersave"
      max_cpu_freq: "3.8 GHz"
      gpu_power_limit: 15
    balanced:
      cpu_governor: "schedutil"
      max_cpu_freq: "4.5 GHz"
      gpu_power_limit: 25
    performance:
      cpu_governor: "performance"
      max_cpu_freq: "5.1 GHz"
      gpu_power_limit: 35

monitoring:
  cpu_temp_warning: 80
  cpu_temp_critical: 95
  memory_warning: 85
  memory_critical: 95
  disk_warning: 80
  disk_critical: 90
