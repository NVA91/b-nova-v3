---
# NOVA v3 - System Setup Playbook
# Führt die grundlegende Systemkonfiguration für Proxmox VE durch

- name: "NOVA v3 - System Setup"
  hosts: proxmox_servers
  become: true
  gather_facts: true

  vars:
    # System-Konfiguration
    system_timezone: "Europe/Berlin"
    system_locale: "de_DE.UTF-8"

    # Firewall-Konfiguration
    enable_firewall: true
    ssh_port: 22

    # Logging
    log_dir: "/var/log/nova_v3"

    # Kernel-Management
    remove_debian_kernel: false

    # Pakete für System-Setup
    system_setup_packages:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - software-properties-common
      - git
      - vim
      - htop
      - net-tools
      - dnsutils
      - python3
      - python3-pip
      - python3-venv

  pre_tasks:
    - name: "Pre-Check: Proxmox VE Installation validieren"
      ansible.builtin.stat:
        path: /etc/pve
      register: pve_check
      failed_when: not pve_check.stat.exists
      tags:
        - always

    - name: "Pre-Check: Ansible-Version anzeigen"
      ansible.builtin.debug:
        msg: "Ansible Version: {{ ansible_version.full }}"
      tags:
        - always

  roles:
    - role: system_setup
      tags:
        - system_setup

  post_tasks:
    - name: "Post-Check: Reboot erforderlich?"
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required
      tags:
        - always

    - name: "Post-Check: Reboot-Warnung"
      ansible.builtin.debug:
        msg:
          - "WARNUNG: Ein Reboot ist erforderlich!"
          - "Führen Sie 'ansible-playbook playbooks/system_setup.yml -e reboot_now=true' aus"
          - "um den Server neu zu starten."
      when: reboot_required.stat.exists
      tags:
        - always

    - name: "Post-Check: Reboot durchführen (optional)"
      ansible.builtin.reboot:
        reboot_timeout: 600
      when:
        - reboot_required.stat.exists
        - reboot_now | default(false) | bool
      tags:
        - always
