version: '3.8'

services:
  n8n:
    image: n8nio/n8n:{{ n8n_version }}
    container_name: n8n
    restart: {{ n8n_restart_policy }}
    ports:
      - "{{ n8n_port }}:5678"
    environment:
      - N8N_HOST={{ n8n_host }}
      - N8N_PORT=5678
      - N8N_PROTOCOL={{ n8n_protocol }}
      - N8N_WEBHOOK_URL={{ n8n_webhook_url }}
      - N8N_BASIC_AUTH_ACTIVE={{ n8n_basic_auth_active | lower }}
      - N8N_BASIC_AUTH_USER={{ n8n_basic_auth_user }}
      - N8N_BASIC_AUTH_PASSWORD={{ n8n_basic_auth_password }}
      - GENERIC_TIMEZONE={{ n8n_timezone }}
      - DB_TYPE={{ n8n_db_type }}
      - DB_POSTGRESDB_HOST={{ n8n_db_host }}
      - DB_POSTGRESDB_PORT={{ n8n_db_port }}
      - DB_POSTGRESDB_DATABASE={{ n8n_db_name }}
      - DB_POSTGRESDB_USER={{ n8n_db_user }}
      - DB_POSTGRESDB_PASSWORD={{ n8n_db_password }}
      {% if n8n_telegram_bot_token %}
      - N8N_TELEGRAM_BOT_TOKEN={{ n8n_telegram_bot_token }}
      {% endif %}
    volumes:
      - {{ n8n_data_path }}:/home/node/.n8n
    networks:
      - nova-v3-network
    security_opt: {{ n8n_security_opts }}
    cap_drop: {{ n8n_cap_drop }}
    {% if n8n_traefik_enabled %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule={{ n8n_traefik_rule }}"
      - "traefik.http.routers.n8n.entrypoints={{ n8n_traefik_entrypoint }}"
      {% if n8n_traefik_tls_enabled %}
      - "traefik.http.routers.n8n.tls.certresolver={{ n8n_traefik_certresolver }}"
      {% endif %}
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"
      - "traefik.http.middlewares.n8n-auth.basicauth.users={{ n8n_basic_auth_user }}:{{ n8n_basic_auth_password | password_hash('bcrypt') }}"
      - "traefik.http.routers.n8n.middlewares=n8n-auth"
    {% endif %}

networks:
  nova-v3-network:
    external: true
    name: nova-v3-network