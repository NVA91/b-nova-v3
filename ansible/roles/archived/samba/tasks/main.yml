---
# üìÅ Samba Role - Main Tasks
# Installiert und konfiguriert Samba-Server f√ºr Netzwerk-Shares

- name: Install Samba packages
  ansible.builtin.apt:
    name:
      - samba
      - samba-common-bin
      - cifs-utils
    state: present
    update_cache: yes
  become: yes

- name: Create Samba share directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner | default('nobody') }}"
    group: "{{ item.group | default('nogroup') }}"
    mode: "{{ item.mode | default('0775') }}"
  loop: "{{ samba_shares }}"
  become: yes

- name: Configure Samba
  ansible.builtin.template:
    src: smb.conf.j2
    dest: /etc/samba/smb.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes
  notify: restart samba
  become: yes

- name: Create Samba users
  ansible.builtin.shell: |
    (echo "{{ item.password }}"; echo "{{ item.password }}") | smbpasswd -a {{ item.username }} -s
  loop: "{{ samba_users }}"
  when: samba_users is defined
  no_log: true
  become: yes
  changed_when: false

- name: Enable Samba users
  ansible.builtin.shell: smbpasswd -e {{ item.username }}
  loop: "{{ samba_users }}"
  when: samba_users is defined
  become: yes
  changed_when: false

- name: Start and enable Samba services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - smbd
    - nmbd
  become: yes

- name: Configure firewall for Samba
  ansible.builtin.ufw:
    rule: allow
    name: Samba
  when: ansible_os_family == "Debian"
  become: yes
