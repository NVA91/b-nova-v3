---
# system_setup Role - Proxmox VE Grundkonfiguration

# ============================================================================
# Preflight: Hardware Validation
# ============================================================================
- name: "Preflight: Run hardware validation"
  ansible.builtin.include_role:
    name: hardware/hardware_validation
  when: hardware_validation_enabled | default(true)
  tags:
    - hardware_validation
    - preflight

# ============================================================================
# SECTION 1: Proxmox Repository Management
# ============================================================================
- name: "Proxmox Repos: Enterprise Repository deaktivieren (keine Subscription)"
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/pve-enterprise.list
    state: absent
  when: ansible_facts['distribution'] == 'Debian'
  tags:
    - system_setup
    - repos
    - proxmox

- name: "Proxmox Repos: No-Subscription Repository hinzufügen (Bookworm Forced)"
  ansible.builtin.apt_repository:
    repo: "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription"
    state: present
    filename: pve-no-subscription
  when: ansible_facts['distribution'] == 'Debian'
  tags:
    - system_setup
    - repos
    - proxmox

- name: "Proxmox Repos: Proxmox Release Key modern herunterladen (Bookworm Forced)"
  ansible.builtin.get_url:
    url: "http://download.proxmox.com/debian/proxmox-release-bookworm.gpg"
    dest: "/etc/apt/trusted.gpg.d/proxmox-release-bookworm.gpg"
    mode: '0644'
    force: true
  when: ansible_facts['distribution'] == 'Debian'
  tags:
    - system_setup
    - repos
    - proxmox

# ============================================================================
# SECTION 2: Paket-Updates und Installation
# ============================================================================

- name: "System: Paket-Manager aktualisieren"
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_facts['os_family'] == 'Debian'
  tags:
    - system_setup
    - packages

- name: "System: Alle Pakete aktualisieren (inkl. PVE Kernel)"
  ansible.builtin.apt:
    upgrade: dist
    autoremove: yes
  when: ansible_facts['os_family'] == 'Debian'
  tags:
    - system_setup
    - packages
    - proxmox

- name: "System: Erforderliche Pakete installieren"
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
      - ca-certificates
      - sudo
      - git
    state: present
    update_cache: yes
  when: ansible_facts['os_family'] == 'Debian'
  tags:
    - system_setup
    - packages

- name: "Proxmox: ifupdown2 installieren (für Netzwerk-Management)"
  ansible.builtin.apt:
    name: ifupdown2
    state: present
  when: ansible_facts['os_family'] == 'Debian'
  tags:
    - system_setup
    - packages
    - proxmox
    - network

# ============================================================================
# SECTION 2.5: Storage-Validierung und ZFS-Setup
# ============================================================================

- name: "Storage: Prüfe ob alle 3 NVMe-SSDs vorhanden sind"
  ansible.builtin.stat:
    path: "{{ item }}"
  register: nvme_devices
  loop:
    - "/dev/nvme0n1"  # VM Storage
    - "/dev/nvme1n1"  # General Storage
    - "/dev/nvme2n1"  # System
  tags:
    - system_setup
    - storage

- name: "Storage: Validierung - Alle SSDs müssen vorhanden sein"
  ansible.builtin.assert:
    that:
      - nvme_devices.results | selectattr('stat.exists') | list | length == 3
    fail_msg: |
      ❌ FEHLER: Nicht alle 3 NVMe-SSDs gefunden!
      Bitte Pre-Flight-Checks ausführen.
  tags:
    - system_setup
    - storage

- name: "Storage: ZFS-Tools installieren"
  ansible.builtin.apt:
    name:
      - zfsutils-linux
      - zfs-dkms
    state: present
  when: ansible_facts['os_family'] == 'Debian'
  tags:
    - system_setup
    - storage
    - zfs

- name: "Storage: ZFS-Pool für VMs erstellen (vmpool)"
  community.general.zpool:
    name: vmpool
    devices:
      - /dev/nvme0n1
    state: present
  when: zfs_enabled | default(false)
  tags:
    - system_setup
    - storage
    - zfs

- name: "Storage: ZFS-Pool für Storage erstellen (tank)"
  community.general.zpool:
    name: tank
    devices:
      - /dev/nvme1n1
    state: present
  when: zfs_enabled | default(false)
  tags:
    - system_setup
    - storage
    - zfs

- name: "Storage: ZFS ARC-Limit setzen (globaler Wert)"
  ansible.builtin.lineinfile:
    path: /etc/modprobe.d/zfs.conf
    regexp: '^options zfs zfs_arc_max='
    line: "options zfs zfs_arc_max={{ zfs_arc_max_bytes }}"
    create: yes
    backup: yes
  vars:
    vmpool_arc_gb: "{{ ((nova_hardware | default({})).get('spec', {}).get('storage', {}).get('vm_disk', {}).get('zfs_arc_max', '0 GB') | regex_replace(' GB', '') | int) }}"
    tank_arc_gb: "{{ ((nova_hardware | default({})).get('spec', {}).get('storage', {}).get('storage_disk', {}).get('zfs_arc_max', '0 GB') | regex_replace(' GB', '') | int) }}"
    zfs_arc_max_bytes: "{{ ([vmpool_arc_gb | int, tank_arc_gb | int] | max * 1024 * 1024 * 1024) }}"
  when: zfs_enabled | default(false)
  tags:
    - system_setup
    - storage
    - zfs

# ============================================================================
# SECTION 3: Kernel und Reboot Management
# ============================================================================

- name: "Proxmox: Prüfe ob PVE Kernel lädt"
  ansible.builtin.command:
    cmd: "uname -r"
  register: kernel_check
  changed_when: false
  tags:
    - system_setup
    - kernel
    - proxmox

- name: "Proxmox: Warnung wenn Standard-Kernel lädt"
  ansible.builtin.debug:
    msg:
      - "WARNUNG: Standard-Debian-Kernel wird verwendet ({{ kernel_check.stdout }})"
      - "Proxmox sollte mit dem PVE-Kernel booten"
      - "Ein Reboot ist empfohlen"
  when: "'pve' not in kernel_check.stdout"
  tags:
    - system_setup
    - kernel
    - proxmox

- name: "Proxmox: Entferne Standard-Debian-Kernel (optional)"
  ansible.builtin.apt:
    name: linux-image-amd64
    state: absent
  when: 
    - ansible_facts['os_family'] == 'Debian'
    - remove_debian_kernel | default(false) | bool
  tags:
    - system_setup
    - kernel
    - proxmox

# ============================================================================
# SECTION 3.5: Kernel-Parameter für GPU/NPU-Passthrough
# ============================================================================

- name: "Kernel: IOMMU-Parameter für AMD-Vi setzen"
  ansible.builtin.lineinfile:
    path: /etc/default/grub
    regexp: '^GRUB_CMDLINE_LINUX_DEFAULT='
    line: 'GRUB_CMDLINE_LINUX_DEFAULT="quiet amd_iommu=on iommu=pt pcie_acs_override=downstream,multifunction video=efifb:off"'
    backup: yes
  notify: update_grub
  tags:
    - system_setup
    - kernel
    - iommu
    - gpu_passthrough

- name: "Kernel: VFIO-Module für GPU-Passthrough laden"
  ansible.builtin.blockinfile:
    path: /etc/modules-load.d/vfio.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK - VFIO MODULES"
    block: |
      vfio
      vfio_iommu_type1
      vfio_pci
      vfio_virqfd
    create: yes
    mode: '0644'
  tags:
    - system_setup
    - kernel
    - gpu_passthrough

- name: "Kernel: NVIDIA-Treiber blacklisten (für Passthrough)"
  ansible.builtin.blockinfile:
    path: /etc/modprobe.d/blacklist-nvidia.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK - NVIDIA BLACKLIST"
    block: |
      blacklist nouveau
      blacklist nvidia
      blacklist nvidia_drm
      blacklist nvidia_modeset
    create: yes
    mode: '0644'
  when: (nova_hardware | default({})).get('gpu', {}).get('egpu', {}).get('enabled', false)
  tags:
    - system_setup
    - kernel
    - gpu_passthrough

- name: "Kernel: initramfs aktualisieren"
  ansible.builtin.command:
    cmd: update-initramfs -u
  when: initramfs_needs_update | default(false)
  tags:
    - system_setup
    - kernel

# ============================================================================
# SECTION 4: Systemkonfiguration
# ============================================================================

- name: "System: Zeitzone setzen"
  community.general.timezone:
    name: "{{ system_timezone | default('UTC') }}"
  tags:
    - system_setup
    - configuration

- name: "System: Locale konfigurieren"
  ansible.builtin.lineinfile:
    path: /etc/default/locale
    regexp: '^LANG='
    line: 'LANG={{ system_locale | default("en_US.UTF-8") }}'
    create: yes
  when: ansible_facts['os_family'] == 'Debian'
  tags:
    - system_setup
    - configuration

- name: "System: Locales generieren"
  ansible.builtin.command:
    cmd: "locale-gen {{ system_locale | default('de_DE.UTF-8') }}"
  register: locale_gen
  changed_when: "'generating' in locale_gen.stdout"
  tags:
    - system_setup
    - configuration

- name: "System: Hostname validieren (nicht ändern bei laufendem PVE)"
  ansible.builtin.assert:
    that:
      - inventory_hostname == ansible_facts['hostname']
    fail_msg: |
      Hostname-Mismatch erkannt!
      Inventory: {{ inventory_hostname }}
      System: {{ ansible_facts['hostname'] }}
      Hostname-Änderungen bei laufendem Proxmox sind kritisch und erfordern manuelle Schritte.
      Bitte synchronisieren Sie die Hostnamen manuell oder kontaktieren Sie den Administrator.
  tags:
    - system_setup
    - configuration
    - proxmox

# ============================================================================
# SECTION 5: Firewall Management
# ============================================================================

- name: "Firewall: UFW entfernen (inkompatibel mit PVE Firewall)"
  ansible.builtin.apt:
    name: ufw
    state: absent
  when: ansible_facts['os_family'] == 'Debian'
  tags:
    - system_setup
    - firewall
    - proxmox

- name: "Firewall: PVE Firewall Verzeichnis (Single-Node)"
  ansible.builtin.file:
    path: /etc/pve/firewall
    state: directory
    mode: '0755'
  tags:
    - system_setup
    - firewall
    - proxmox

- name: "Proxmox: LXC Docker-Support (Bedingt)"
  ansible.builtin.blockinfile:
    path: "/etc/pve/lxc/{{ item }}.conf"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - DOCKER PERMISSIONS"
    block: |
      lxc.apparmor.profile: unconfined
      lxc.cap.drop: 
      lxc.cgroup.devices.allow: a
    backup: yes
  loop: "{{ lxc_container_ids }}"
  when:
    - allow_docker_in_lxc | default(false)
    - lxc_container_ids is defined
  tags:
    - proxmox
    - lxc_fix

# - name: "Firewall: PVE Firewall aktivieren (Cluster Level)"
#   ansible.builtin.lineinfile:
#     path: /etc/pve/firewall/cluster.fw
#     line: "enable: 1"
#     create: yes
#     mode: '0644'
#     unsafe_writes: true
#   tags:
#     - system_setup
#     - firewall
#     - proxmox

# - name: "Firewall: SSH Regel hinzufügen (Management)"
#   ansible.builtin.blockinfile:
#     path: /etc/pve/firewall/cluster.fw
#     block: |
#       [RULES]
#       IN SSH(ACCEPT)
#       IN HTTPS(ACCEPT)
#     create: yes
#     mode: '0644'
#     unsafe_writes: true
#   tags:
#     - system_setup
#     - firewall
#     - proxmox

# ============================================================================
# SECTION 6: Logging und Verzeichnisse
# ============================================================================

- name: "System: Log-Verzeichnis erstellen"
  ansible.builtin.file:
    path: "{{ log_dir }}"
    state: directory
    mode: '0755'
  tags:
    - system_setup
    - logging

- name: "System: Abschluss-Meldung"
  ansible.builtin.debug:
    msg:
      - "System-Setup erfolgreich abgeschlossen"
      - "Proxmox VE Basis-Konfiguration durchgeführt"
      - "Repositories konfiguriert"
      - "Firewall konfiguriert"
  tags:
    - system_setup


