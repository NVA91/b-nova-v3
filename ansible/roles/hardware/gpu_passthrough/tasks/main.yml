---
# gpu_hookscript Role - Dynamisches GPU-Passthrough

- name: "Hookscript: PCI-IDs normalisieren (gpu_pci_ids oder nova_hardware)"
  ansible.builtin.set_fact:
    gpu_hookscript_pci_ids: >-
      {{
        (gpu_pci_ids | default([]))
        if (gpu_pci_ids | default([]) | length) > 0
        else (
          [nova_hardware.spec.gpu.egpu.pci_id]
          + ([nova_hardware.spec.gpu.egpu.audio_pci_id] if (nova_hardware.spec.gpu.egpu.audio_pci_id is defined and nova_hardware.spec.gpu.egpu.audio_pci_id | length > 0) else [])
        )
        if (nova_hardware is defined and nova_hardware.spec is defined and nova_hardware.spec.gpu is defined and nova_hardware.spec.gpu.egpu is defined and nova_hardware.spec.gpu.egpu.pci_id is defined)
        else []
      }}
  tags:
    - gpu_hookscript

- name: "Fail if GPU PCI ID is not defined"
  ansible.builtin.fail:
    msg: "GPU PCI ID ist nicht gesetzt – kann GPU Passthrough nicht konfigurieren. Setze gpu_pci_ids oder nova_hardware.spec.gpu.egpu.pci_id."
  when: gpu_vm_id is defined and (gpu_hookscript_pci_ids | length) == 0
  tags:
    - gpu_hookscript

- name: "Hookscript: Validierung der PCI-IDs"
  ansible.builtin.assert:
    that:
      - (gpu_hookscript_pci_ids | length) > 0
      - (gpu_hookscript_pci_ids | select('match', '^[0-9a-fA-F]{4}:[0-9a-fA-F]{2}:[0-9a-fA-F]{2}\.[0-7]$') | list | length) == (gpu_hookscript_pci_ids | length)
    fail_msg: "GPU PCI IDs müssen gültig sein (Format 0000:01:00.0)."
  when: (gpu_hookscript_pci_ids | length) > 0
  tags:
    - gpu_hookscript

- name: "Hookscript: Verzeichnis erstellen"
  ansible.builtin.file:
    path: /var/lib/vz/snippets
    state: directory
    mode: '0755'
  when: (gpu_hookscript_pci_ids | length) > 0
  tags:
    - gpu_hookscript

- name: "Hookscript: Logdatei sicherstellen"
  ansible.builtin.file:
    path: "{{ gpu_hookscript_log | default('/var/log/pve-gpu-hookscript.log') }}"
    state: touch
    owner: root
    group: root
    mode: '0640'
  when: (gpu_hookscript_pci_ids | length) > 0
  tags:
    - gpu_hookscript

- name: "Install GPU hookscript"
  ansible.builtin.template:
    src: gpu-hookscript.pl.j2
    dest: /var/lib/vz/snippets/gpu-hookscript.pl
    mode: '0755'
  when: (gpu_hookscript_pci_ids | length) > 0
  tags:
    - gpu_hookscript

- name: "Hookscript: VM-Konfiguration anpassen"
  ansible.builtin.lineinfile:
    path: "/etc/pve/qemu-server/{{ gpu_vm_id }}.conf"
    line: "hookscript: local:snippets/gpu-hookscript.pl"
    create: no
  when: gpu_vm_id is defined and (gpu_hookscript_pci_ids | length) > 0
  tags:
    - gpu_hookscript