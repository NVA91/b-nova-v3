---
# Hardware Validation Role (SSoT Gatekeeper)
# Compares live facts against the declared hardware_profile loaded from inventory.

- name: "Hardware Validation: Ensure hardware_profile is provided"
  ansible.builtin.assert:
    that:
      - hardware_profile is defined
      - hardware_profile.spec is defined
    fail_msg: >-
      hardware_profile ist nicht gesetzt. Stelle sicher, dass das Production-Inventory ein
      hardware_profile via lookup() lädt (inventory/hardware/pve01.yml).
  tags:
    - hardware_validation
    - preflight

- name: "Hardware Validation: Gather facts (hardware/devices/network)"
  ansible.builtin.setup:
    gather_subset:
      - hardware
      - devices
      - network
  tags:
    - hardware_validation
    - preflight

- name: "Hardware Validation: Compute expected/actual CPU and RAM"
  ansible.builtin.set_fact:
    hv_expected_cpu_cores: "{{ hardware_profile.spec.cpu.cores | int }}"
    hv_expected_cpu_threads: "{{ hardware_profile.spec.cpu.threads | int }}"
    hv_expected_ram_mb: "{{ (hardware_profile.spec.memory.total_gb | float * 1024) | int }}"
    hv_actual_cpu_cores: "{{ (ansible_processor_cores | int) * (ansible_processor_count | int) }}"
    hv_actual_cpu_threads: "{{ ansible_processor_vcpus | int }}"
    hv_actual_ram_mb: "{{ ansible_memtotal_mb | int }}"
  tags:
    - hardware_validation
    - preflight

- name: "Hardware Validation: CPU cores (strict)"
  ansible.builtin.assert:
    that:
      - hv_actual_cpu_cores == hv_expected_cpu_cores
    fail_msg: "CPU-Kerne mismatch. Erwartet: {{ hv_expected_cpu_cores }}, gefunden: {{ hv_actual_cpu_cores }}"
    success_msg: "CPU-Kerne OK (strict): {{ hv_actual_cpu_cores }}"
  when: hardware_validation_strict_mode | default(false) | bool
  tags:
    - hardware_validation
    - cpu

- name: "Hardware Validation: CPU cores (minimum)"
  ansible.builtin.assert:
    that:
      - hv_actual_cpu_cores >= hv_expected_cpu_cores
    fail_msg: "CPU-Kerne zu wenig. Erwartet mind.: {{ hv_expected_cpu_cores }}, gefunden: {{ hv_actual_cpu_cores }}"
    success_msg: "CPU-Kerne OK: {{ hv_actual_cpu_cores }}"
  when: not (hardware_validation_strict_mode | default(false) | bool)
  tags:
    - hardware_validation
    - cpu

- name: "Hardware Validation: CPU threads (strict)"
  ansible.builtin.assert:
    that:
      - hv_actual_cpu_threads == hv_expected_cpu_threads
    fail_msg: "CPU-Threads mismatch. Erwartet: {{ hv_expected_cpu_threads }}, gefunden: {{ hv_actual_cpu_threads }}"
    success_msg: "CPU-Threads OK (strict): {{ hv_actual_cpu_threads }}"
  when: hardware_validation_strict_mode | default(false) | bool
  tags:
    - hardware_validation
    - cpu

- name: "Hardware Validation: CPU threads (minimum)"
  ansible.builtin.assert:
    that:
      - hv_actual_cpu_threads >= hv_expected_cpu_threads
    fail_msg: "CPU-Threads zu wenig. Erwartet mind.: {{ hv_expected_cpu_threads }}, gefunden: {{ hv_actual_cpu_threads }}"
    success_msg: "CPU-Threads OK: {{ hv_actual_cpu_threads }}"
  when: not (hardware_validation_strict_mode | default(false) | bool)
  tags:
    - hardware_validation
    - cpu

- name: "Hardware Validation: RAM (minimum)"
  ansible.builtin.assert:
    that:
      - hv_actual_ram_mb >= hv_expected_ram_mb
    fail_msg: "RAM zu wenig. Erwartet mind.: {{ hv_expected_ram_mb }}MB, gefunden: {{ hv_actual_ram_mb }}MB"
    success_msg: "RAM OK: {{ (hv_actual_ram_mb / 1024) | round(2) }}GB"
  tags:
    - hardware_validation
    - ram

- name: "Hardware Validation: Build expected storage device list"
  ansible.builtin.set_fact:
    hv_expected_storage_devices: >-
      {{
        [
          hardware_profile.spec.storage.vm_disk.device,
          hardware_profile.spec.storage.storage_disk.device,
          hardware_profile.spec.storage.system_disk.device
        ]
        | select('defined')
        | select('string')
        | list
      }}
  tags:
    - hardware_validation
    - storage

- name: "Hardware Validation: Validate declared storage devices exist"
  ansible.builtin.assert:
    that:
      - (item | regex_replace('^/dev/', '')) in (ansible_devices.keys() | list)
    fail_msg: "Storage-Device fehlt: {{ item }} (nicht in ansible_devices)"
    success_msg: "Storage-Device OK: {{ item }}"
  loop: "{{ hv_expected_storage_devices }}"
  tags:
    - hardware_validation
    - storage

- name: "Hardware Validation: Collect PCI inventory (numeric)"
  ansible.builtin.command:
    cmd: lspci -Dn
  register: hv_lspci
  changed_when: false
  tags:
    - hardware_validation
    - pci

- name: "Hardware Validation: Validate eGPU PCI device id"
  ansible.builtin.assert:
    that:
      - (hv_lspci.stdout | lower) is search((hardware_profile.gpu.egpu.passthrough.pci_device_id | lower))
    fail_msg: "eGPU nicht gefunden (PCI-ID {{ hardware_profile.gpu.egpu.passthrough.pci_device_id }}). Prüfe OCuLink/DEG1/Power/Bios."
    success_msg: "eGPU PCI-ID OK: {{ hardware_profile.gpu.egpu.passthrough.pci_device_id }}"
  when:
    - (hardware_profile.gpu.egpu.enabled | default(false)) | bool
    - hardware_profile.gpu.egpu.passthrough is defined
    - hardware_profile.gpu.egpu.passthrough.pci_device_id is defined
  tags:
    - hardware_validation
    - gpu

- name: "Hardware Validation: Validate NPU PCI device id"
  ansible.builtin.assert:
    that:
      - (hv_lspci.stdout | lower) is search((hardware_profile.npu.pci_id | lower))
    fail_msg: "NPU nicht gefunden (PCI-ID {{ hardware_profile.npu.pci_id }}). Prüfe BIOS/Kernel >= {{ hardware_profile.npu.kernel_min_version | default('6.8') }}."
    success_msg: "NPU PCI-ID OK: {{ hardware_profile.npu.pci_id }}"
  when:
    - (hardware_profile.npu.enabled | default(false)) | bool
    - hardware_profile.npu.pci_id is defined
  tags:
    - hardware_validation
    - npu

- name: "Hardware Validation: Validate LAN controllers (count)"
  ansible.builtin.assert:
    that:
      - (hv_lspci.stdout | lower | regex_findall((item.pci_device_id | lower)) | length) >= (item.count | default(1) | int)
    fail_msg: "LAN Controller mismatch: {{ item.pci_device_id }} count < {{ item.count | default(1) }}"
    success_msg: "LAN Controller OK: {{ item.pci_device_id }}"
  loop: "{{ hardware_profile.network.lan.controllers | default([]) }}"
  when:
    - hardware_profile.network is defined
    - hardware_profile.network.lan is defined
    - hardware_profile.network.lan.controllers is defined
  tags:
    - hardware_validation
    - network

- name: "Hardware Validation: Summary"
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "HARDWARE VALIDATION SUCCESSFUL"
      - "Host: {{ inventory_hostname }}"
      - "CPU: {{ hv_actual_cpu_threads }} threads / {{ hv_actual_cpu_cores }} cores (expected {{ hv_expected_cpu_threads }}/{{ hv_expected_cpu_cores }})"
      - "RAM: {{ (hv_actual_ram_mb / 1024) | round(2) }}GB (expected >= {{ (hv_expected_ram_mb / 1024) | round(2) }}GB)"
      - "Disks: {{ hv_expected_storage_devices }}"
      - "eGPU enabled: {{ hardware_profile.gpu.egpu.enabled | default(false) }}"
      - "NPU enabled: {{ hardware_profile.npu.enabled | default(false) }}"
      - "=========================================="
  when: hardware_validation_show_details | default(true) | bool
  tags:
    - hardware_validation
