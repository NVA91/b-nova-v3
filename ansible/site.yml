---
#+#+#+#+############################################
# SSoT Deployment Playbook
# - Hardware-Profil wird im Inventory als hardware_profile geladen
# - hardware_validation fungiert als Gatekeeper
#+#+#+#+############################################

- name: "PLAY 1: Pre-Flight Checks & Hardware Validation"
  hosts: proxmox_servers
  gather_facts: true
  become: true
  roles:
    - role: hardware/hardware_validation

- name: "PLAY 2: Proxmox Host Vorbereitung"
  hosts: proxmox_servers
  gather_facts: true
  become: true

  pre_tasks:
    - name: "SSoT: Mappe hardware_profile.* auf Legacy Variablen (Kompatibilität)"
      ansible.builtin.set_fact:
        # Proxmox platform settings
        zfs_enabled: "{{ hardware_profile.proxmox.zfs_enabled | default(false) }}"
        storage_thin_pool: "{{ hardware_profile.proxmox.storage_thin_pool | default('local-lvm') }}"
        vm_storage: "{{ hardware_profile.proxmox.vm_storage | default('local-lvm') }}"
        backup_storage: "{{ hardware_profile.proxmox.backup_storage | default('local') }}"
        dir_storage: "{{ hardware_profile.proxmox.dir_storage | default('local') }}"
        allow_docker_in_lxc: "{{ hardware_profile.proxmox.allow_docker_in_lxc | default(false) }}"
        lxc_container_ids: "{{ hardware_profile.proxmox.lxc_container_ids | default([]) }}"

        # GPU passthrough settings
        proxmox_gpu_passthrough: "{{ hardware_profile.proxmox.gpu_passthrough | default({}) }}"
        gpu_pci_ids: >-
          {{
            (
              [hardware_profile.gpu.egpu.passthrough.pci_id]
              + ([hardware_profile.gpu.egpu.passthrough.audio_pci_id] if (hardware_profile.gpu.egpu.passthrough.audio_pci_id is defined and hardware_profile.gpu.egpu.passthrough.audio_pci_id | length > 0) else [])
            )
            if (hardware_profile.gpu.egpu.enabled | default(false)) and (hardware_profile.gpu.egpu.passthrough.enabled | default(false))
            else []
          }}

        # Optional legacy blob for older roles/templates
        nova_hardware: "{{ {'spec': hardware_profile.spec, 'gpu': {'egpu': hardware_profile.gpu.egpu | default({})}, 'npu': hardware_profile.npu | default({})} } }"
      when: hardware_profile is defined
      tags: [preflight]

  roles:
    - role: core/system_setup
    - role: core/user_management
    - role: hardware/gpu_passthrough
      when: (hardware_profile.gpu.egpu.enabled | default(false)) and (hardware_profile.gpu.egpu.passthrough.enabled | default(false))

- name: "PLAY 3: VM-Provisioning"
  hosts: proxmox_servers
  gather_facts: true
  become: true
  roles:
    - role: core/provision_guests
  tags:
    - never
    - provision

- name: "PLAY 4: Docker Setup auf Guest VMs"
  hosts: guest_vms
  gather_facts: true
  become: true
  serial: 1
  roles:
    - role: core/docker_setup

- name: "PLAY 5: App Deployment auf Guest VMs"
  hosts: guest_vms
  gather_facts: false
  become: true
  serial: 1
  roles:
    - role: apps/app_deployment

- name: "PLAY 6: QA Smoke Tests"
  hosts: proxmox_servers
  gather_facts: false
  become: true
  roles:
    - role: qa_smoke

- name: "PLAY 7: Hardware Security (Validation-only)"
  hosts: proxmox_servers
  gather_facts: true
  become: true
  roles:
    - role: hardware/hardware_security
  tags:
    - never
    - hardware_security

- name: "PLAY 8: Deployment Abschluss"
  hosts: localhost
  gather_facts: false

  tasks:
    - name: "Report: Deployment Summary"
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "DEPLOYMENT ERFOLGREICH ABGESCHLOSSEN"
          - "=========================================="
          - "Inventory: production"
          - "Targets: proxmox_servers={{ groups['proxmox_servers'] | default([]) }}"
          - "Zeitstempel: {{ ansible_date_time.iso8601 }}"
          - "=========================================="
      tags:
        - report

    - name: "Report: Nächste Schritte"
      ansible.builtin.debug:
        msg:
          - ""
          - "Nächste Schritte:"
          - "1. Überprüfe die VMs: ssh admin@vm-gateway.example.local"
          - "2. Öffne die Dashboards:"
          - "   - Traefik: http://localhost:8080"
          - "   - Paperless: http://localhost:8000"
          - "   - N8N: http://localhost:5678"
          - "3. Konfiguriere WireGuard für Remote-Zugriff"
          - "4. Richte DNS-Einträge ein"
          - ""
      tags:
        - report
