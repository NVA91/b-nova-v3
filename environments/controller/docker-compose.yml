---
# AWX/Ansible Tower Controller Environment
# Isolated sandbox for testing and automation management

services:
  # ==========================================================================
  # PostgreSQL Database (simplified)
  # ==========================================================================
  awx-postgres:
    image: postgres:15-alpine
    container_name: awx-postgres
    environment:
      POSTGRES_DB: awx
      POSTGRES_USER: awx
      POSTGRES_PASSWORD: ${AWX_DB_PASSWORD}
    volumes:
      - awx-db:/var/lib/postgresql/data
    restart: unless-stopped

  # ============================================================================
  # Redis Cache (simplified)
  # ============================================================================
  awx-redis:
    image: redis:7-alpine
    container_name: awx-redis
    restart: unless-stopped

  # ============================================================================
  # AWX Web Interface & API (simplified)
  # ============================================================================
  awx-web:
    image: ansible/awx:latest
    container_name: awx-web
    depends_on:
      - awx-postgres
      - awx-redis
    environment:
      SECRET_KEY: ${AWX_SECRET_KEY}
      DATABASE_HOST: awx-postgres
      REDIS_HOST: awx-redis
    ports:
      - "8080:8052"
    volumes:
      - awx-projects:/var/lib/awx/projects
      - ../../ansible:/ansible:ro  # Read-only mount
    restart: unless-stopped

  # ============================================================================
  # AWX Task Manager (Ansible Job Executor)
  # ============================================================================


# ============================================================================
# Networks
# ============================================================================
networks:
  awx-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

# ============================================================================
# Volumes
# ============================================================================
volumes:
  awx-projects:
  awx-db:
