---
- name: Sammle Live-Hardware-Fakten
  setup:

- name: Vergleiche CPU-Kerne mit Definition
  ansible.builtin.assert:
    that:
      - ansible_processor_cores == hardware_profile.cpu.cores
    fail_msg: "CPU-Kernanzahl stimmt nicht! Erwartet: {{ hardware_profile.cpu.cores }}, gefunden: {{ ansible_processor_cores }}"
  when: hardware_profile.cpu.cores is defined

- name: Prüfe Existenz der VM-Storage-Festplatte
  ansible.builtin.stat:
    path: "{{ item.device }}"
  loop: "{{ hardware_profile.storage.devices }}"
  register: storage_check
  when: item.purpose == 'vm_storage'

- name: Stelle sicher, dass Storage-Geräte vorhanden sind
  ansible.builtin.assert:
    that: storage_check.results | map(attribute='stat.exists') | all
    fail_msg: "Mindestens ein definiertes Storage-Gerät fehlt."

- name: Prüfe ob eGPU aktiviert ist
  ansible.builtin.assert:
    that:
      - hardware_profile.gpu.egpu.enabled | default(false)
    fail_msg: "eGPU ist laut Hardwareprofil nicht aktiviert!"
  when: hardware_profile.gpu.egpu is defined

- name: Prüfe NVIDIA Treiber ist installiert
  ansible.builtin.shell: which nvidia-smi
  register: nvidia_driver_check
  failed_when: nvidia_driver_check.rc != 0
  changed_when: false

- name: Lese NVIDIA GPU Informationen
  ansible.builtin.shell: |
    nvidia-smi --query-gpu=name,pci.device_id,temperature.gpu --format=csv,noheader,nounits
  register: gpu_info
  changed_when: false

- name: Splitte GPU-Infos in Variablen
  set_fact:
    gpu_model: "{{ gpu_info.stdout_lines[0].split(',')[0] | trim }}"
    gpu_pci_id: "{{ '10de:' ~ gpu_info.stdout_lines[0].split(',')[1] | trim }}"
    gpu_temp: "{{ gpu_info.stdout_lines[0].split(',')[2] | int }}"

- name: Validierung: GPU-Modell ist RTX 5060 Ti
  ansible.builtin.assert:
    that:
      - "'RTX 5060 Ti' in gpu_model"
    fail_msg: "Falsches GPU-Modell erkannt: {{ gpu_model }}. Erwartet: RTX 5060 Ti"

- name: Validierung: PCI-ID passt zum Hardwareprofil
  ansible.builtin.assert:
    that:
      - gpu_pci_id == hardware_profile.gpu.egpu.pci_id
    fail_msg: "PCI-ID stimmt nicht überein: {{ gpu_pci_id }} ≠ {{ hardware_profile.gpu.egpu.pci_id }}"

- name: Abbruch wenn GPU überhitzt (>85°C)
  ansible.builtin.assert:
    that:
      - gpu_temp < 85
    fail_msg: "GPU zu heiß: {{ gpu_temp }}°C"