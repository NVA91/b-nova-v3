---
# 6-docker-compose.n8n.yml
# Modular Docker Compose für n8n (safe-docker)
# Zweck: separater, optionaler Service. Nicht automatisch in main-Deployments einbinden.
# Verwendung: docker compose -f docker-compose.yml -f tools/ansible-controller/safe-docker/6-docker-compose.n8n.yml up -d
# Wenn du ein lokales, angepasstes n8n-Image bauen willst, benutze die Dockerfile unter
# dockerfiles/Dockerfile.n8n und aktiviere die untere "build"-Variante (kommentiert).

version: '3.8'

services:
  n8n:
    # Standard: offizielles Image (unkommentieren, falls du statt build verwenden willst)
    image: n8nio/n8n:latest
    # Optional: Eigenes Image bauen - Kommentar entfernen, wenn benötigt
    # build:
    #   context: ./dockerfiles
    #   dockerfile: Dockerfile.n8n
    #   args:
    #     N8N_VERSION: latest
    
    container_name: safe-n8n
    container_name: safe-n8n
    restart: unless-stopped
    environment:
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-true}
      - N8N_BASIC_AUTH_USER=${N8N_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD}
      - N8N_HOST=n8n.${DOMAIN}
      - N8N_PORT=${N8N_PORT:-5678}
      - N8N_PROTOCOL=${N8N_PROTOCOL:-https}
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-https://n8n.${DOMAIN}}
      - DB_TYPE=${N8N_DB_TYPE:-postgresdb}
      - DB_POSTGRESDB_HOST=${N8N_DB_HOST:-db}
      - DB_POSTGRESDB_PORT=${N8N_DB_PORT:-5432}
      - DB_POSTGRESDB_DATABASE=${N8N_DB_NAME:-n8n}
      - DB_POSTGRESDB_USER=${N8N_DB_USER:-n8n}
      - DB_POSTGRESDB_PASSWORD=${N8N_DB_PASSWORD:-changeme}
      - GENERIC_TIMEZONE=${N8N_TIMEZONE:-Europe/Berlin}
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - proxmox_net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5678/healthz"]
      interval: 10s
      timeout: 5s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.${DOMAIN}`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls=true"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=5678"

volumes:
  n8n-data:
    driver: local

networks:
  proxmox_net:
    external: true
    name: proxmox_net
